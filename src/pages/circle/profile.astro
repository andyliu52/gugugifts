---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';

const apiUrl = import.meta.env.PUBLIC_API_URL || '';
---

<Layout title="Complete Your Profile | gugugifts Circle" description="Complete your gugugifts Circle profile to earn bonus points.">
  <Navbar />

  <main id="main-content" class="pt-28 pb-20">
    <section class="max-w-md mx-auto px-6">
      <div class="text-center mb-10">
        <p class="text-xs uppercase tracking-[0.2em] text-gold mb-4 font-medium">The Circle</p>
        <h1 class="font-playfair text-3xl md:text-4xl font-medium mb-4">Complete Your Profile</h1>
        <div class="divider-gold mx-auto mb-4"></div>
        <p class="text-bronze-light leading-relaxed">
          Earn <strong class="text-bronze">100 bonus points</strong> for adding your info, plus
          <strong class="text-bronze">50 more</strong> if you add your birthday.
        </p>
      </div>

      <form id="profile-form" data-api={apiUrl} class="space-y-5">
        <div>
          <label for="first_name" class="block text-xs uppercase tracking-widest text-bronze-light mb-2">First Name</label>
          <input
            type="text"
            id="first_name"
            name="first_name"
            required
            class="w-full px-4 py-3 rounded-lg border border-cream-dark bg-white text-bronze focus:outline-none focus:border-gold transition-colors"
            placeholder="Your first name"
          />
        </div>

        <div>
          <label for="last_name" class="block text-xs uppercase tracking-widest text-bronze-light mb-2">Last Name</label>
          <input
            type="text"
            id="last_name"
            name="last_name"
            class="w-full px-4 py-3 rounded-lg border border-cream-dark bg-white text-bronze focus:outline-none focus:border-gold transition-colors"
            placeholder="Your last name (optional)"
          />
        </div>

        <div>
          <label for="email" class="block text-xs uppercase tracking-widest text-bronze-light mb-2">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 rounded-lg border border-cream-dark bg-white text-bronze focus:outline-none focus:border-gold transition-colors"
            placeholder="you@example.com"
          />
        </div>

        <div>
          <label for="birthday" class="block text-xs uppercase tracking-widest text-bronze-light mb-2">Birthday <span class="normal-case tracking-normal">(+50 pts)</span></label>
          <input
            type="date"
            id="birthday"
            name="birthday"
            class="w-full px-4 py-3 rounded-lg border border-cream-dark bg-white text-bronze focus:outline-none focus:border-gold transition-colors"
          />
        </div>

        <button
          type="submit"
          class="w-full py-3 bg-gold text-white text-sm uppercase tracking-widest rounded-lg hover:bg-gold-light transition-colors font-medium"
        >
          Save & Earn Points
        </button>

        <p id="form-message" class="text-center text-sm hidden"></p>
      </form>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  const form = document.getElementById('profile-form') as HTMLFormElement;
  const msg = document.getElementById('form-message')!;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.classList.add('hidden');

    const params = new URLSearchParams(window.location.search);
    const customerId = params.get('id');
    if (!customerId) {
      msg.textContent = 'Missing customer ID. Use the link from your enrollment text.';
      msg.className = 'text-center text-sm text-rose';
      msg.classList.remove('hidden');
      return;
    }

    const api = form.dataset.api || '';
    const body: Record<string, string> = {};

    const first = (form.querySelector('#first_name') as HTMLInputElement).value.trim();
    const last = (form.querySelector('#last_name') as HTMLInputElement).value.trim();
    const email = (form.querySelector('#email') as HTMLInputElement).value.trim();
    const birthday = (form.querySelector('#birthday') as HTMLInputElement).value;

    if (first) body.first_name = first;
    if (last) body.last_name = last;
    if (email) body.email = email;
    if (birthday) body.birthday = birthday;

    try {
      const res = await fetch(`${api}/api/loyalty/customer/${customerId}/profile`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (!res.ok) {
        msg.textContent = data.error || 'Something went wrong.';
        msg.className = 'text-center text-sm text-rose';
        msg.classList.remove('hidden');
        return;
      }

      form.innerHTML = `
        <div class="text-center py-8">
          <div class="w-16 h-16 rounded-full bg-gold/10 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h2 class="font-playfair text-2xl mb-2">You're all set!</h2>
          <p class="text-bronze-light mb-2">You earned <strong class="text-gold">${data.bonus_awarded} bonus points</strong>.</p>
          <p class="text-bronze-light">Your balance is now <strong class="text-bronze">${data.balance} points</strong>.</p>
          <a href="/circle" class="inline-block mt-6 text-gold text-sm uppercase tracking-widest hover:text-gold-light transition-colors">Learn more about the Circle &rarr;</a>
        </div>
      `;
    } catch {
      msg.textContent = 'Network error. Please try again.';
      msg.className = 'text-center text-sm text-rose';
      msg.classList.remove('hidden');
    }
  });
</script>
