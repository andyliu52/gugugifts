---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';

const apiUrl = import.meta.env.PUBLIC_API_URL || '';
---

<Layout title="Account Settings | The Gugu Gang" description="Manage your gugu gang account preferences, marketing settings, and account.">
  <Navbar />

  <main id="main-content" class="pt-28 pb-20">
    <section class="max-w-md mx-auto px-6">
      <div class="text-center mb-10">
        <p class="text-xs uppercase tracking-[0.2em] text-gold mb-4 font-medium">the gugu gang</p>
        <h1 class="font-playfair text-3xl md:text-4xl font-medium mb-4">Account Settings</h1>
        <div class="divider-gold mx-auto mb-4"></div>
      </div>

      <!-- Login step -->
      <div id="login-section">
        <p class="text-bronze-light leading-relaxed text-center mb-6">Enter your phone number to manage your account.</p>
        <form id="login-form" data-api={apiUrl}>
          <div class="flex gap-3">
            <input
              type="tel"
              id="phone"
              placeholder="+1 (555) 123-4567"
              required
              class="flex-1 px-4 py-3 rounded-lg border border-cream-dark bg-white text-bronze focus:outline-none focus:border-gold transition-colors"
            />
            <button
              type="submit"
              class="px-6 py-3 bg-gold text-white text-sm uppercase tracking-widest rounded-lg hover:bg-gold-light transition-colors font-medium whitespace-nowrap"
            >
              Log In
            </button>
          </div>
          <p id="login-error" class="mt-3 text-center text-sm text-rose hidden"></p>
        </form>
      </div>

      <!-- Settings (hidden until login) -->
      <div id="settings-section" class="hidden space-y-6">
        <!-- Account info -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xs uppercase tracking-widest text-gold font-medium mb-4">Your Account</h2>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-bronze-light">Name</span>
              <span id="display-name" class="font-medium"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-bronze-light">Phone</span>
              <span id="display-phone" class="font-medium"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-bronze-light">Email</span>
              <span id="display-email" class="font-medium"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-bronze-light">Member since</span>
              <span id="display-since" class="font-medium"></span>
            </div>
          </div>
        </div>

        <!-- Marketing preferences -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xs uppercase tracking-widest text-gold font-medium mb-2">Communication Preferences</h2>
          <p class="text-xs text-bronze-light mb-5">Choose how you'd like to hear from us.</p>

          <div class="space-y-4">
            <label class="flex items-center justify-between cursor-pointer group">
              <div>
                <p class="text-sm font-medium">Email notifications</p>
                <p class="text-xs text-bronze-light">Rewards, birthday perks, balance updates</p>
              </div>
              <div class="relative">
                <input type="checkbox" id="toggle-email" class="sr-only peer" />
                <div class="w-11 h-6 bg-cream-dark rounded-full peer-checked:bg-gold transition-colors"></div>
                <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-5"></div>
              </div>
            </label>

            <div class="h-px bg-cream-dark"></div>

            <label class="flex items-center justify-between cursor-pointer group">
              <div>
                <p class="text-sm font-medium">Text messages (SMS)</p>
                <p class="text-xs text-bronze-light">Enrollment confirmations, milestone alerts</p>
              </div>
              <div class="relative">
                <input type="checkbox" id="toggle-sms" class="sr-only peer" />
                <div class="w-11 h-6 bg-cream-dark rounded-full peer-checked:bg-gold transition-colors"></div>
                <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform peer-checked:translate-x-5"></div>
              </div>
            </label>
          </div>

          <p id="prefs-message" class="mt-4 text-center text-sm hidden"></p>
        </div>

        <!-- Danger zone -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-rose/20">
          <h2 class="text-xs uppercase tracking-widest text-rose font-medium mb-2">Delete Account</h2>
          <p class="text-xs text-bronze-light mb-4">
            This will permanently delete your gugu gang account, points balance, rewards, and all associated data. This action cannot be undone.
          </p>
          <button
            id="delete-btn"
            class="w-full py-3 bg-white text-rose text-sm uppercase tracking-widest rounded-lg border border-rose hover:bg-rose hover:text-white transition-colors font-medium"
          >
            Delete My Account
          </button>
        </div>

        <div class="text-center">
          <a href="/circle/lookup" class="text-gold text-sm uppercase tracking-widest hover:text-gold-light transition-colors">
            &larr; Back to Balance
          </a>
        </div>
      </div>

      <!-- Delete confirmation modal -->
      <div id="delete-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40" id="modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-6">
          <div class="bg-white rounded-xl shadow-lg max-w-sm w-full p-8 relative">
            <h3 class="font-playfair text-xl mb-3 text-center">Are you sure?</h3>
            <p class="text-sm text-bronze-light text-center mb-6">
              All your points, rewards, and account data will be permanently deleted. You'll need to re-enroll to rejoin the gugu gang.
            </p>
            <div class="flex gap-3">
              <button id="modal-cancel" class="flex-1 py-3 bg-cream-dark text-bronze text-sm uppercase tracking-widest rounded-lg hover:bg-cream transition-colors font-medium">
                Cancel
              </button>
              <button id="modal-confirm" class="flex-1 py-3 bg-rose text-white text-sm uppercase tracking-widest rounded-lg hover:bg-rose/80 transition-colors font-medium">
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Deleted confirmation -->
      <div id="deleted-section" class="hidden text-center py-8">
        <div class="w-16 h-16 rounded-full bg-cream-dark flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-bronze-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 class="font-playfair text-2xl mb-2">Account Deleted</h2>
        <p class="text-bronze-light mb-6">Your gugu gang account and all associated data have been removed.</p>
        <a href="/circle" class="text-gold text-sm uppercase tracking-widest hover:text-gold-light transition-colors">
          Back to the gugu gang &rarr;
        </a>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  const loginSection = document.getElementById('login-section')!;
  const settingsSection = document.getElementById('settings-section')!;
  const deletedSection = document.getElementById('deleted-section')!;
  const loginForm = document.getElementById('login-form') as HTMLFormElement;
  const loginError = document.getElementById('login-error')!;

  const api = loginForm.dataset.api || '';
  let customerId = '';

  function formatPhone(raw: string): string {
    const digits = raw.replace(/\D/g, '');
    if (digits.length === 10) return `+1${digits}`;
    if (digits.length === 11 && digits.startsWith('1')) return `+${digits}`;
    return raw.startsWith('+') ? raw : `+${digits}`;
  }

  function formatPhoneDisplay(phone: string): string {
    const d = phone.replace(/\D/g, '');
    if (d.length === 11 && d.startsWith('1')) {
      return `(${d.slice(1, 4)}) ${d.slice(4, 7)}-${d.slice(7)}`;
    }
    return phone;
  }

  // Check if we got here via a link with ?id= param (from email unsubscribe)
  const params = new URLSearchParams(window.location.search);
  const idFromUrl = params.get('id');

  if (idFromUrl) {
    loadSettingsById(idFromUrl);
  }

  async function loadSettingsById(id: string) {
    try {
      const res = await fetch(`${api}/api/loyalty/customer?phone=_byid_`, { method: 'GET' });
      // We don't have a get-by-id endpoint on the lookup route, so use preferences + a workaround
      // Actually let's just look up preferences directly
      const prefsRes = await fetch(`${api}/api/loyalty/customer/${id}/preferences`);
      if (!prefsRes.ok) {
        // Customer not found, show login form
        return;
      }
      const prefs = await prefsRes.json();
      customerId = id;

      // We need customer details too - but we only have phone-based lookup
      // Show settings with limited info
      document.getElementById('display-name')!.textContent = '—';
      document.getElementById('display-phone')!.textContent = '—';
      document.getElementById('display-email')!.textContent = '—';
      document.getElementById('display-since')!.textContent = '—';

      (document.getElementById('toggle-email') as HTMLInputElement).checked = prefs.email_enabled;
      (document.getElementById('toggle-sms') as HTMLInputElement).checked = prefs.sms_enabled;

      loginSection.classList.add('hidden');
      settingsSection.classList.remove('hidden');
    } catch {
      // Show login form as fallback
    }
  }

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginError.classList.add('hidden');

    const phoneInput = (document.getElementById('phone') as HTMLInputElement).value.trim();
    const phone = formatPhone(phoneInput);

    try {
      const res = await fetch(`${api}/api/loyalty/customer?phone=${encodeURIComponent(phone)}`);
      const data = await res.json();

      if (!res.ok) {
        loginError.textContent = data.error || 'Account not found.';
        loginError.classList.remove('hidden');
        return;
      }

      const c = data.customer;
      customerId = c.id;

      const name = [c.first_name, c.last_name].filter(Boolean).join(' ') || '—';
      document.getElementById('display-name')!.textContent = name;
      document.getElementById('display-phone')!.textContent = formatPhoneDisplay(c.phone);
      document.getElementById('display-email')!.textContent = c.email || '—';
      document.getElementById('display-since')!.textContent = new Date(c.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      (document.getElementById('toggle-email') as HTMLInputElement).checked = c.email_enabled;
      (document.getElementById('toggle-sms') as HTMLInputElement).checked = c.sms_enabled;

      loginSection.classList.add('hidden');
      settingsSection.classList.remove('hidden');
    } catch {
      loginError.textContent = 'Network error. Please try again.';
      loginError.classList.remove('hidden');
    }
  });

  // Toggle handlers
  const prefsMsg = document.getElementById('prefs-message')!;

  async function updatePref(field: string, value: boolean) {
    prefsMsg.classList.add('hidden');
    try {
      const res = await fetch(`${api}/api/loyalty/customer/${customerId}/preferences`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [field]: value }),
      });

      if (!res.ok) {
        prefsMsg.textContent = 'Failed to update. Please try again.';
        prefsMsg.className = 'mt-4 text-center text-sm text-rose';
        prefsMsg.classList.remove('hidden');
        return;
      }

      prefsMsg.textContent = 'Preferences updated.';
      prefsMsg.className = 'mt-4 text-center text-sm text-gold';
      prefsMsg.classList.remove('hidden');
      setTimeout(() => prefsMsg.classList.add('hidden'), 2500);
    } catch {
      prefsMsg.textContent = 'Network error. Please try again.';
      prefsMsg.className = 'mt-4 text-center text-sm text-rose';
      prefsMsg.classList.remove('hidden');
    }
  }

  document.getElementById('toggle-email')!.addEventListener('change', (e) => {
    updatePref('email_enabled', (e.target as HTMLInputElement).checked);
  });

  document.getElementById('toggle-sms')!.addEventListener('change', (e) => {
    updatePref('sms_enabled', (e.target as HTMLInputElement).checked);
  });

  // Delete account
  const deleteModal = document.getElementById('delete-modal')!;

  document.getElementById('delete-btn')!.addEventListener('click', () => {
    deleteModal.classList.remove('hidden');
  });

  document.getElementById('modal-cancel')!.addEventListener('click', () => {
    deleteModal.classList.add('hidden');
  });

  document.getElementById('modal-backdrop')!.addEventListener('click', () => {
    deleteModal.classList.add('hidden');
  });

  document.getElementById('modal-confirm')!.addEventListener('click', async () => {
    deleteModal.classList.add('hidden');

    try {
      const res = await fetch(`${api}/api/loyalty/customer/${customerId}`, {
        method: 'DELETE',
      });

      if (!res.ok) {
        const data = await res.json();
        alert(data.error || 'Failed to delete account.');
        return;
      }

      settingsSection.classList.add('hidden');
      deletedSection.classList.remove('hidden');
    } catch {
      alert('Network error. Please try again.');
    }
  });
</script>
